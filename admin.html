<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o Inteligente - CCB</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; display: block !important; height: auto !important; }
        
        .header-admin {
            display: flex; justify-content: space-between; align-items: center;
            background: #0b1b3d; color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;
        }

        .container-planilha {
            background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px; overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #e9ecef; padding: 12px; text-align: left; color: #495057; }
        td { padding: 10px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        
        /* O Seletor Inteligente */
        select.select-grupo {
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px;
            background-color: #fff; font-weight: bold; color: #333;
        }

        /* Cores para o status */
        .status-cheio { color: #dc3545; font-weight: bold; } /* Vermelho se lotar */
        .status-ok { color: #28a745; font-weight: bold; }    /* Verde se livre */
        
        .btn-salvar {
            background: #007bff; color: white; border: none; padding: 8px 15px; 
            border-radius: 5px; cursor: pointer; width: 100%;
        }
        .btn-salvar:hover { background: #0056b3; }
    </style>
</head>
<body>

    <div class="header-admin">
        <h3>ðŸ“‹ DistribuiÃ§Ã£o de Versos</h3>
        <button onclick="sair()" style="background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:4px;">Sair</button>
    </div>

    <div class="container-planilha">
        <h2 style="color:#0b1b3d;">Escala de SÃ¡bado</h2>
        <p>Selecione o bloco de versos. O sistema controla os grupos automaticamente (MÃ¡x 3 por grupo).</p>
        
        <table>
            <thead>
                <tr>
                    <th>IrmÃ£o</th>
                    <th>SeleÃ§Ã£o de Versos (Grupo AutomÃ¡tico)</th>
                    <th style="width: 100px;">AÃ§Ã£o</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="3">Carregando sistema...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yyktessyxnloyjwmydoj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3Rlc3N5eG5sb3lqd215ZG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQ1NzUsImV4cCI6MjA4NTkyMDU3NX0.bvktQ_DFH-CIszOlL0j1vrlIRM5sW3DIamjUy2fT__g';
        const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- CONFIGURAÃ‡ÃƒO DOS GRUPOS ---
        const OPCOES_VERSOS = [
            { grupo: 'A', versos: '1 ao 3' },
            { grupo: 'B', versos: '4 ao 6' },
            { grupo: 'C', versos: '7 ao 9' },
            { grupo: 'D', versos: '10 ao 13' },
            { grupo: 'E', versos: '14 ao 16' }
        ];
        const LIMITE_POR_GRUPO = 3;

        if (localStorage.getItem('usuario_funcao') !== 'ADMIN') window.location.href = 'index.html';

        async function carregarPlanilha() {
            const corpo = document.getElementById('tabela-corpo');
            
            // 1. Busca dados
            const { data: perfis } = await clienteSupabase.from('profiles').select('*').eq('funcao', 'MEMBRO').order('nome_completo');
            const { data: atribuicoes } = await clienteSupabase.from('versoes_atribuidas').select('*');

            // 2. Conta lotaÃ§Ã£o
            let contadorGrupos = { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 };
            atribuicoes.forEach(a => {
                if(a.grupo && contadorGrupos[a.grupo] !== undefined) contadorGrupos[a.grupo]++;
            });

            let html = '';

            perfis.forEach(perfil => {
                const tarefa = atribuicoes.find(a => a.usuario_id === perfil.id) || {};
                const grupoAtual = tarefa.grupo || '';
                
                let opcoesHtml = `<option value="">-- Sem AtribuiÃ§Ã£o --</option>`;
                
                OPCOES_VERSOS.forEach(op => {
                    const isSelected = (grupoAtual === op.grupo) ? 'selected' : '';
                    let ocupados = contadorGrupos[op.grupo];
                    let aviso = `(${ocupados}/${LIMITE_POR_GRUPO})`;
                    let estilo = (ocupados >= LIMITE_POR_GRUPO && !isSelected) ? 'ðŸ”´ CHEIO' : aviso;

                    opcoesHtml += `<option value="${op.grupo}|${op.versos}" ${isSelected}>
                        Grupo ${op.grupo}: Versos ${op.versos} ${estilo}
                    </option>`;
                });

                html += `
                    <tr>
                        <td><strong>${perfil.email.split('@')[0]}</strong></td>
                        <td>
                            <select class="select-grupo" id="select-${perfil.id}" onchange="verificarLotacao(this)">
                                ${opcoesHtml}
                            </select>
                        </td>
                        <td>
                            <button class="btn-salvar" onclick="salvarLinha('${perfil.id}', '${tarefa.id || ''}')">ðŸ’¾ Salvar</button>
                        </td>
                    </tr>
                `;
            });
            corpo.innerHTML = html;
        }

        function verificarLotacao(select) {
            let texto = select.options[select.selectedIndex].text;
            if (texto.includes('CHEIO')) {
                alert("AtenÃ§Ã£o: Grupo cheio! Deseja continuar?");
                select.style.border = "2px solid red";
            } else {
                select.style.border = "1px solid #ced4da";
            }
        }

        async function salvarLinha(usuarioId, idAtribuicao) {
            const select = document.getElementById(`select-${usuarioId}`);
            const valor = select.value;

            if (!valor) return; // Se quiser limpar, precisaria implementar delete

            const [grupo, versos] = valor.split('|');

            const { data: recitativos } = await clienteSupabase.from('recitativos').select('id').eq('ativo', true).limit(1);
            if(!recitativos || !recitativos.length) return alert("Crie um recitativo primeiro!");

            const dados = {
                usuario_id: usuarioId,
                recitativo_id: recitativos[0].id,
                grupo: grupo,
                faixa_versos: versos
            };

            let erro;
            if (idAtribuicao) {
                const { error } = await clienteSupabase.from('versoes_atribuidas').update(dados).eq('id', idAtribuicao);
                erro = error;
            } else {
                const { error } = await clienteSupabase.from('versoes_atribuidas').insert([dados]);
                erro = error;
            }

            if (erro) alert("Erro: " + erro.message);
            else carregarPlanilha(); 
        }

        function sair() { localStorage.clear(); window.location.href = 'index.html'; }
        carregarPlanilha();
    </script>
</body>
</html>
