<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dedica√ß√£o - CCB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUAIS --- */
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; padding: 20px; background: #f0f2f5; min-height: 100vh; }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2.saudacao-texto { color: #0b1b3d; margin: 0; font-weight: 800; font-size: 1.4rem; }
        .subtitulo-saudacao { color: #666; font-size: 0.9rem; }
        .btn-sair { padding: 8px 15px; border: 1px solid #ccc; background: transparent; border-radius: 20px; cursor: pointer; color: #555; font-weight: 600; }

        .recitativo-card { background-color: #fffde7; border-left: 5px solid #fbc02d; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .recitativo-titulo { font-weight: 800; color: #f57f17; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 5px; }
        .recitativo-texto { font-style: italic; color: #444; font-size: 1rem; }

        .dashboard-card { background: #eef2f8; border: 1px solid #ccd6e0; border-radius: 20px; padding: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        
        .grupo-badge { background-color: #4a76c5; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; align-self: flex-start; }
        
        .card-content { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .perfil-area { display: flex; align-items: center; gap: 10px; min-width: 140px; }
        .avatar { width: 45px; height: 45px; background: #e76f51; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; border: 2px solid white; }
        .info-nome div { font-weight: 800; color: #333; font-size: 0.95rem; }
        .info-nome span { font-size: 0.75rem; color: #666; }

        /* QUADRADINHOS DE DEDICA√á√ÉO */
        .dedicacao-area { display: flex; gap: 4px; margin-top: 5px; }
        .dia-quadrado { width: 12px; height: 12px; background: #d0d0d0; border-radius: 3px; transition: all 0.3s; }
        .dia-quadrado.verde { background: #28a745; border: 1px solid #1e7e34; } /* Estudou */
        .dia-quadrado.hoje { background: #ff9800; border: 1px solid #e65100; transform: scale(1.2); } /* Dia Atual */

        /* CAIXA DE VERSOS (O Algoritmo vai agir aqui depois) */
        .verso-box { background: #4a76c5; color: white; padding: 10px 20px; border-radius: 8px; text-align: center; flex-grow: 1; min-width: 100px; }
        .verso-box small { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .verso-box strong { display: block; font-size: 1.1rem; }

        /* GR√ÅFICO DE DEDICA√á√ÉO */
        .grafico-area { display: flex; align-items: center; gap: 10px; background: white; padding: 5px 10px; border-radius: 50px; border: 1px solid #ddd; }
        .donut-chart { width: 40px; height: 40px; border-radius: 50%; background: conic-gradient(#3d5a80 0% 0%, #e0e0e0 0% 100%); display: flex; align-items: center; justify-content: center; }
        .donut-hole { width: 28px; height: 28px; background: white; border-radius: 50%; }
        .porcentagem-texto { font-weight: bold; font-size: 0.8rem; color: #333; }

        .btn-confirmar { background: #00b894; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .status-presenca { width: 15px; height: 15px; border-radius: 50%; background: #ccc; border: 2px solid white; position: absolute; top: 15px; right: 15px; }
        .status-presenca.ok { background: #00b894; box-shadow: 0 0 5px #00b894; }
        .section-label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 30px; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-top">
        <div>
            <h2 id="saudacao-titulo" class="saudacao-texto">A Paz de Deus!</h2>
            <div class="subtitulo-saudacao">Sua dedica√ß√£o semanal:</div>
        </div>
        <button onclick="sair()" class="btn-sair">Sair</button>
    </div>

    <div id="area-texto-biblico"></div>
    <div id="meu-painel"><p style="text-align:center">Carregando...</p></div>
    
    <div class="section-label">Irmandade Ativa</div>
    <div id="lista-outros"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yyktessyxnloyjwmydoj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3Rlc3N5eG5sb3lqd215ZG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQ1NzUsImV4cCI6MjA4NTkyMDU3NX0.bvktQ_DFH-CIszOlL0j1vrlIRM5sW3DIamjUy2fT__g';
        const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const meuId = localStorage.getItem('usuario_id');
        if (!meuId) window.location.href = 'index.html';

        // L√ìGICA DE DEDICA√á√ÉO (SIMULADA POR ENQUANTO)
        // Pega o dia da semana: 0=Dom, 1=Seg, 2=Ter, 3=Qua...
        const hoje = new Date().getDay(); 
        // Se for Domingo (0), vamos considerar que a semana acabou (6 dias estudados)
        const diaSemanaIndex = hoje === 0 ? 6 : hoje - 1; // Ajusta para Seg=0, Ter=1...
        
        function gerarQuadradinhos() {
            let html = '';
            const dias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
            
            dias.forEach((dia, index) => {
                let classe = '';
                if (index < diaSemanaIndex) classe = 'verde'; // Dias passados = Estudados
                else if (index === diaSemanaIndex) classe = 'hoje'; // Hoje
                else classe = ''; // Futuro = Cinza
                
                html += `<div class="dia-quadrado ${classe}" title="${dia}"></div>`;
            });
            return html;
        }

        async function carregarTudo() {
            try {
                // 1. Busca Dados B√°sicos
                const { data: perfis } = await clienteSupabase.from('profiles').select('*');
                const meuPerfil = perfis.find(p => p.id === meuId);
                
                if (meuPerfil) {
                    const nome = meuPerfil.nome_completo ? meuPerfil.nome_completo.split(' ')[0] : 'Irm√£o';
                    const trat = (meuPerfil.genero === 'FEMININO') ? 'Irm√£' : 'Irm√£o';
                    document.getElementById('saudacao-titulo').innerText = `A Paz de Deus, ${trat} ${nome}!`;
                }

                // 2. Recitativo
                const { data: recitativos } = await clienteSupabase.from('recitativos').select('*').eq('ativo', true).limit(1);
                if (!recitativos.length) { document.getElementById('meu-painel').innerHTML = 'Sem recitativo.'; return; }
                const recitativo = recitativos[0];

                document.getElementById('area-texto-biblico').innerHTML = `
                    <div class="recitativo-card">
                        <div class="recitativo-titulo">üìñ ${recitativo.tema}</div>
                        <div class="recitativo-texto">"${recitativo.conteudo_texto || '...'}"</div>
                    </div>`;

                // 3. Atribui√ß√µes (Ordenado por NOME para preparar o Algoritmo Alfab√©tico)
                const { data: atribuicoes } = await clienteSupabase
                    .from('versoes_atribuidas')
                    .select('*')
                    .eq('recitativo_id', recitativo.id); // Tirei a ordem de grupo por enquanto

                // Junta Perfis
                let participantes = atribuicoes.map(atrib => {
                    const perfil = perfis.find(p => p.id === atrib.usuario_id) || {};
                    return { ...atrib, profiles: perfil };
                });

                // ORDEM ALFAB√âTICA (Fundamental para o seu algoritmo futuro)
                participantes.sort((a, b) => {
                    const nomeA = a.profiles.nome_completo || "";
                    const nomeB = b.profiles.nome_completo || "";
                    return nomeA.localeCompare(nomeB);
                });

                const eu = participantes.find(p => p.usuario_id === meuId);
                const outros = participantes.filter(p => p.usuario_id !== meuId);

                if (eu) renderizarCard(eu, 'meu-painel', true);
                else document.getElementById('meu-painel').innerHTML = 'N√£o escalado.';
                
                document.getElementById('lista-outros').innerHTML = '';
                outros.forEach(p => renderizarCard(p, 'lista-outros', false));

            } catch (e) { console.error(e); }
        }

        function renderizarCard(dados, containerId, souEu) {
            let nome = dados.profiles.nome_completo || dados.profiles.email?.split('@')[0];
            const inicial = nome.charAt(0).toUpperCase();
            const confirmado = dados.presenca_confirmada;
            
            // C√ÅLCULO DE DEDICA√á√ÉO (Baseado nos dias da semana que passaram)
            // Ex: Se hoje √© Quarta (3¬∫ dia √∫til), dedica√ß√£o √© 50% da semana de 6 dias
            const pctDedicao = Math.round(((diaSemanaIndex + 1) / 6) * 100);
            const corGrafico = '#ff9800'; // Laranja de dedica√ß√£o

            let btnHtml = '';
            if (souEu) {
                const txt = confirmado ? 'Presen√ßa Confirmada' : 'Confirmar Presen√ßa';
                const cor = confirmado ? '#00b894' : '#4a76c5';
                btnHtml = `<div style="width:100%; margin-top:10px;"><button class="btn-confirmar" style="background:${cor}" onclick="toggle('${dados.id}', ${confirmado})">${txt}</button></div>`;
            }

            const html = `
                <div class="dashboard-card">
                    <div class="status-presenca ${confirmado ? 'ok' : ''}"></div>
                    <span class="grupo-badge">GRUPO ${dados.grupo}</span>
                    <div class="card-content">
                        <div class="perfil-area">
                            <div class="avatar">${inicial}</div>
                            <div class="info-nome"><div>${nome}</div>
                                <div class="dedicacao-area">
                                    ${gerarQuadradinhos()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="verso-box">
                            <small>Sua Parte:</small>
                            <strong>Versos ${dados.faixa_versos}</strong>
                        </div>
                        
                        <div class="grafico-area" title="Sua dedica√ß√£o na semana">
                            <div class="donut-chart" style="background: conic-gradient(${corGrafico} 0% ${pctDedicao}%, #e0e0e0 ${pctDedicao}%, #e0e0e0 100%);">
                                <div class="donut-hole"></div>
                            </div>
                            <span class="porcentagem-texto">${pctDedicao}%</span>
                        </div>
                    </div>
                    ${btnHtml}
                </div>`;
            
            if (souEu) document.getElementById(containerId).innerHTML = html;
            else document.getElementById(containerId).innerHTML += html;
        }

        async function toggle(id, estado) {
            document.querySelector('.btn-confirmar').innerText = '...';
            await clienteSupabase.from('versoes_atribuidas').update({ presenca_confirmada: !estado }).eq('id', id);
            carregarTudo();
        }
        function sair() { localStorage.clear(); window.location.href = 'index.html'; }
        carregarTudo();
    </script>
</body>
</html>
