<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Miss√£o - CCB</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos do Cart√£o */
        .card-missao {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 20px;
            border-top: 5px solid #007bff; /* Detalhe azul no topo */
        }

        .data-destaque {
            background-color: #f8f9fa;
            color: #555;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .texto-biblico {
            background-color: #fffbe6; /* Amarelinho de papel antigo */
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd700;
            font-style: italic;
            color: #444;
            margin: 20px 0;
            text-align: left;
            font-size: 1em;
            line-height: 1.6;
            white-space: pre-wrap; /* Mant√©m as quebras de linha do texto original */
        }

        .grupo-badge {
            background-color: #0b1b3d; color: white;
            padding: 5px 15px; border-radius: 20px;
            font-size: 0.9em; font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .versos-destaque {
            font-size: 1.4em; font-weight: bold; color: #333;
            margin: 15px 0; display: block;
        }

        /* Bot√£o de Presen√ßa */
        .btn-presenca {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 20px;
        }

        .btn-nao-confirmado { background-color: #e9ecef; color: #495057; border: 2px solid #dee2e6; }
        .btn-confirmado { background-color: #28a745; color: white; border: 2px solid #28a745; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); }

        .historico-bolinhas { display: flex; justify-content: center; gap: 5px; margin-top: 15px; }
        .bolinha { width: 10px; height: 10px; border-radius: 50%; background-color: #e9ecef; }
        .bolinha.cheia { background-color: #28a745; }

    </style>
</head>
<body>

    <div class="login-container" style="max-width: 500px;">
        <div class="header-painel">
            <h2 id="saudacao">A Paz de Deus!</h2>
            <button onclick="sair()" class="btn-sair">Sair</button>
        </div>

        <div id="area-recitativo">
            <p style="text-align: center; color: #666;">Carregando sua miss√£o...</p>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yyktessyxnloyjwmydoj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3Rlc3N5eG5sb3lqd215ZG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQ1NzUsImV4cCI6MjA4NTkyMDU3NX0.bvktQ_DFH-CIszOlL0j1vrlIRM5sW3DIamjUy2fT__g';
        const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const usuarioEmail = localStorage.getItem('usuario_email');
        const usuarioId = localStorage.getItem('usuario_id');
        
        if (!usuarioEmail) window.location.href = 'index.html';
        document.getElementById('saudacao').innerText = `A Paz de Deus, Irm√£o!`;

        // Fun√ß√£o auxiliar para formatar data bonita (Ex: S√°bado, 14 de Fevereiro)
        function formatarData(dataString) {
            if(!dataString) return "Data a definir";
            // Cria a data ajustando o fuso hor√°rio (adiciona T12:00:00 para evitar cair no dia anterior)
            const data = new Date(dataString + 'T12:00:00'); 
            return data.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
        }

        async function carregarMissao() {
            const area = document.getElementById('area-recitativo');

            // 1. Busca Recitativo Ativo
            const { data: recitativos } = await clienteSupabase
                .from('recitativos')
                .select('*')
                .eq('ativo', true)
                .limit(1);

            if (!recitativos || recitativos.length === 0) {
                area.innerHTML = '<div class="card-missao"><p>Nenhum recitativo ativo no momento.</p></div>';
                return;
            }
            const recitativo = recitativos[0];

            // 2. Busca Atribui√ß√£o do Usu√°rio
            const { data: minhasAtribuicoes } = await clienteSupabase
                .from('versoes_atribuidas')
                .select('*')
                .eq('usuario_id', usuarioId)
                .eq('recitativo_id', recitativo.id);

            let cartaoHTML = '';
            
            // Prepara os dados visuais
            const dataFormatada = formatarData(recitativo.data_apresentacao);
            // Se n√£o tiver texto, avisa
            const textoFormatado = recitativo.conteudo_texto ? recitativo.conteudo_texto : "Texto ainda n√£o dispon√≠vel.";

            if (minhasAtribuicoes && minhasAtribuicoes.length > 0) {
                const missao = minhasAtribuicoes[0];
                const statusClass = missao.presenca_confirmada ? 'btn-confirmado' : 'btn-nao-confirmado';
                const textoBotao = missao.presenca_confirmada ? '‚úÖ Presen√ßa Confirmada' : 'Confirmar Presen√ßa';

                cartaoHTML = `
                    <div class="card-missao">
                        <span class="data-destaque">üóìÔ∏è ${dataFormatada}</span>
                        
                        <h3>${recitativo.tema}</h3>
                        <p style="color: #666; font-size: 0.9em; margin-top: 5px;">Ref: ${recitativo.referencia_biblica}</p>
                        
                        <div class="texto-biblico">"${textoFormatado}"</div>

                        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="grupo-badge">GRUPO ${missao.grupo || '?'}</span>
                            <span style="font-size: 1.1em; font-weight: bold; color: #0b1b3d;">Versos: ${missao.faixa_versos}</span>
                        </div>

                        <button id="btn-presenca" class="btn-presenca ${statusClass}" onclick="alternarPresenca('${missao.id}', ${missao.presenca_confirmada})">
                            ${textoBotao}
                        </button>
                    </div>
                `;
            } else {
                cartaoHTML = `
                    <div class="card-missao" style="border-left: 5px solid orange; border-top: none;">
                        <span class="data-destaque">üóìÔ∏è ${dataFormatada}</span>
                        <h3>${recitativo.tema}</h3>
                        <br>
                        <p><strong>Aguardando Distribui√ß√£o...</strong></p>
                        <p>O Auxiliar ainda n√£o definiu seu grupo.</p>
                    </div>
                `;
            }

            area.innerHTML = cartaoHTML;
        }

        async function alternarPresenca(atribuicaoId, estadoAtual) {
            const novoEstado = !estadoAtual;
            const btn = document.getElementById('btn-presenca');
            btn.innerText = "Salvando...";
            
            const { error } = await clienteSupabase
                .from('versoes_atribuidas')
                .update({ presenca_confirmada: novoEstado })
                .eq('id', atribuicaoId);

            if (error) {
                alert("Erro: " + error.message);
                carregarMissao();
            } else {
                carregarMissao();
            }
        }

        function sair() { localStorage.clear(); window.location.href = 'index.html'; }
        carregarMissao();
    </script>
</body>
</html>
