<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Avançado - CCB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- RESET E FUNDO --- */
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            margin: 0; padding: 20px;
            background: #f0f2f5; /* Fundo cinza claro profissional */
            min-height: 100vh;
        }

        /* Título da Página */
        h2.titulo-pagina {
            color: #0b1b3d; text-align: center; margin-bottom: 20px;
            font-weight: 800; letter-spacing: -1px;
        }

        /* --- O CARTÃO MESTRE (Igual seu desenho) --- */
        .dashboard-card {
            background: #eef2f8; /* Azulzinho bem claro do seu desenho */
            border: 1px solid #ccd6e0;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column; /* No celular fica um embaixo do outro */
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative;
        }

        /* Faixa Azul do Grupo */
        .grupo-badge {
            background-color: #4a76c5; color: white;
            padding: 4px 12px; border-radius: 6px;
            font-size: 0.8rem; font-weight: bold;
            align-self: flex-start; margin-bottom: 5px;
        }

        /* Layout Interno do Cartão */
        .card-content {
            display: flex; align-items: center; gap: 15px;
            flex-wrap: wrap; /* Quebra linha se a tela for pequena */
        }

        /* Avatar e Nome */
        .perfil-area { display: flex; align-items: center; gap: 10px; min-width: 120px; }
        .avatar {
            width: 45px; height: 45px; background: #e76f51; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; border: 2px solid white;
        }
        .info-nome div { font-weight: 800; color: #333; font-size: 0.95rem; }
        .info-nome span { font-size: 0.75rem; color: #666; }

        /* A Parte Central (Verso Grande) */
        .verso-box {
            background: #4a76c5; color: white;
            padding: 10px 20px; border-radius: 8px;
            text-align: center; flex-grow: 1;
        }
        .verso-box strong { display: block; font-size: 1.1rem; }
        .verso-box small { font-size: 0.75rem; opacity: 0.8; }

        /* Os Quadradinhos de Dedicação (Seg, Ter...) */
        .dedicacao-area { display: flex; gap: 4px; margin-top: 5px; }
        .dia-quadrado {
            width: 15px; height: 15px; background: #b0b0b0; border-radius: 3px;
        }
        .dia-quadrado.verde { background: #28a745; border: 1px solid #1e7e34; }
        .dia-quadrado.hoje { background: #dc3545; /* Vermelho para hoje */ }

        /* O Gráfico (Donut Chart com CSS Puro) */
        .grafico-area {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 8px; border-radius: 50px;
            border: 1px solid #ddd;
        }
        .donut-chart {
            width: 40px; height: 40px; border-radius: 50%;
            background: conic-gradient(#3d5a80 0% 0%, #e0e0e0 0% 100%); /* O JS vai mudar isso */
            display: flex; align-items: center; justify-content: center;
        }
        .donut-hole { width: 28px; height: 28px; background: white; border-radius: 50%; }
        .porcentagem-texto { font-weight: bold; font-size: 0.9rem; color: #333; }

        /* Botões Laterais */
        .btn-confirmar {
            background: #00b894; color: white; border: none;
            padding: 12px; border-radius: 8px; width: 100%;
            font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-cancelar {
            background: #d63031; color: white; border: none;
            padding: 12px; border-radius: 8px; width: 100%;
            font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        
        /* Status Bolinha */
        .status-presenca {
            width: 15px; height: 15px; border-radius: 50%;
            background: #ccc; border: 2px solid white;
            position: absolute; top: 15px; right: 15px;
        }
        .status-presenca.ok { background: #00b894; box-shadow: 0 0 5px #00b894; }

        /* Lista de Irmãos */
        .section-label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 30px; margin-bottom: 10px; font-weight: bold; }

    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="titulo-pagina">Painel de Leitura</h2>
        <button onclick="sair()" style="padding:5px 10px;">Sair</button>
    </div>

    <div id="meu-painel">
        <p style="text-align:center">Carregando...</p>
    </div>

    <div class="section-label">Irmandade Ativa</div>
    <div id="lista-outros">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yyktessyxnloyjwmydoj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3Rlc3N5eG5sb3lqd215ZG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQ1NzUsImV4cCI6MjA4NTkyMDU3NX0.bvktQ_DFH-CIszOlL0j1vrlIRM5sW3DIamjUy2fT__g';
        const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const meuId = localStorage.getItem('usuario_id');
        if (!meuId) window.location.href = 'index.html';

        async function carregarTudo() {
            // 1. Pega Recitativo Ativo
            const { data: recitativos } = await clienteSupabase.from('recitativos').select('*').eq('ativo', true).limit(1);
            if (!recitativos.length) return document.getElementById('meu-painel').innerHTML = 'Sem recitativo ativo.';
            const recitativo = recitativos[0];

            // 2. Pega todos os participantes
            const { data: participantes } = await clienteSupabase
                .from('versoes_atribuidas')
                .select('*, profiles(nome_completo, email)')
                .eq('recitativo_id', recitativo.id)
                .order('grupo');

            const eu = participantes.find(p => p.usuario_id === meuId);
            const outros = participantes.filter(p => p.usuario_id !== meuId);

            // Renderiza EU (Topo)
            renderizarCard(eu, 'meu-painel', true);
            
            // Renderiza OUTROS (Lista)
            document.getElementById('lista-outros').innerHTML = '';
            outros.forEach(p => renderizarCard(p, 'lista-outros', false));
        }

        function renderizarCard(dados, containerId, souEu) {
            if (!dados) return;

            // Dados Visuais
            const nome = dados.profiles?.nome_completo || dados.profiles?.email.split('@')[0];
            const inicial = nome.charAt(0);
            const confirmado = dados.presenca_confirmada;
            const corBolinha = confirmado ? 'ok' : '';
            
            // Simulação de Porcentagem (Futuramente vem do banco)
            const pct = confirmado ? 100 : 33; 
            const graficoCor = confirmado ? '#00b894' : '#3d5a80';

            // HTML dos controles (Só aparece se for EU)
            let controlesHtml = '';
            if (souEu) {
                const txtBtn = confirmado ? 'Presença OK' : 'Confirmar Presença';
                const styleBtn = confirmado ? 'background:#00b894' : 'background:#4a76c5';
                controlesHtml = `
                    <div style="width:100%; margin-top:10px;">
                        <button class="btn-confirmar" style="${styleBtn}" onclick="toggle('${dados.id}', ${confirmado})">
                            ${txtBtn}
                        </button>
                    </div>
                `;
            }

            const html = `
                <div class="dashboard-card">
                    <div class="status-presenca ${corBolinha}"></div>
                    <span class="grupo-badge">GRUPO ${dados.grupo}</span>

                    <div class="card-content">
                        <div class="perfil-area">
                            <div class="avatar">${inicial}</div>
                            <div class="info-nome">
                                <div>${nome}</div>
                                <span>Membro</span>
                                <div class="dedicacao-area">
                                    <div class="dia-quadrado verde" title="Seg"></div>
                                    <div class="dia-quadrado verde" title="Ter"></div>
                                    <div class="dia-quadrado" title="Qua"></div>
                                    <div class="dia-quadrado hoje" title="Hoje"></div>
                                    <div class="dia-quadrado" title="Sex"></div>
                                </div>
                            </div>
                        </div>

                        <div class="verso-box">
                            <small>Sua Parte:</small>
                            <strong>Versos ${dados.faixa_versos}</strong>
                        </div>

                        <div class="grafico-area">
                            <div class="donut-chart" style="background: conic-gradient(${graficoCor} 0% ${pct}%, #e0e0e0 ${pct}% 100%);">
                                <div class="donut-hole"></div>
                            </div>
                            <span class="porcentagem-texto">${pct}%</span>
                        </div>
                    </div>

                    ${controlesHtml}
                </div>
            `;

            if (souEu) document.getElementById(containerId).innerHTML = html;
            else document.getElementById(containerId).innerHTML += html;
        }

        async function toggle(id, estado) {
            document.querySelector('.btn-confirmar').innerText = '...';
            await clienteSupabase.from('versoes_atribuidas').update({ presenca_confirmada: !estado }).eq('id', id);
            carregarTudo();
        }

        function sair() { localStorage.clear(); window.location.href = 'index.html'; }
        
        carregarTudo();
    </script>
</body>
</html>
