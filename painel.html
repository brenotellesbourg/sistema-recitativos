<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Pessoal - CCB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUAIS --- */
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; padding: 20px; background: #f0f2f5; min-height: 100vh; }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2.saudacao-texto { color: #0b1b3d; margin: 0; font-weight: 800; font-size: 1.4rem; }
        .subtitulo-saudacao { color: #666; font-size: 0.9rem; }
        .btn-sair { padding: 8px 15px; border: 1px solid #ccc; background: transparent; border-radius: 20px; cursor: pointer; color: #555; font-weight: 600; }

        /* PORTAL */
        .btn-portal {
            display: block; width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; text-align: center; padding: 15px;
            border-radius: 15px; text-decoration: none;
            font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
            margin-bottom: 30px; transition: transform 0.2s;
        }
        .btn-portal:hover { transform: translateY(-3px); }

        /* CARDS */
        .recitativo-card { background-color: #fffde7; border-left: 5px solid #fbc02d; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .recitativo-titulo { font-weight: 800; color: #f57f17; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 5px; }
        .recitativo-texto { font-style: italic; color: #444; font-size: 1rem; }

        .dashboard-card { background: #eef2f8; border: 1px solid #ccd6e0; border-radius: 20px; padding: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        .grupo-badge { background-color: #4a76c5; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; align-self: flex-start; }
        
        .card-content { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .perfil-area { display: flex; align-items: center; gap: 10px; min-width: 140px; }
        .avatar { width: 45px; height: 45px; background: #e76f51; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; border: 2px solid white; }
        .info-nome div { font-weight: 800; color: #333; font-size: 0.95rem; }

        /* QUADRADINHOS DE DEDICA√á√ÉO (Reais) */
        .dedicacao-area { display: flex; gap: 4px; margin-top: 5px; }
        .dia-quadrado { width: 12px; height: 12px; background: #d0d0d0; border-radius: 3px; }
        .dia-quadrado.verde { background: #28a745; border: 1px solid #1e7e34; } 
        .dia-quadrado.hoje-vazio { border: 2px solid #ff9800; background: transparent; }

        .verso-box { background: #4a76c5; color: white; padding: 10px 20px; border-radius: 8px; text-align: center; flex-grow: 1; min-width: 100px; }
        .verso-box small { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .verso-box strong { display: block; font-size: 1.1rem; }

        /* O Efeito de Mist√©rio */
.misterio {
    filter: blur(6px);
    user-select: none; /* N√£o deixa selecionar o texto */
    cursor: pointer;
    transition: 0.5s;
}
.misterio:hover {
    filter: blur(4px); /* D√° uma leve clareada se passar o mouse */
}
.revelado {
    filter: none;
    animation: brilha 1s ease;
}
@keyframes brilha {
    0% { background-color: #fff; color: #333; }
    100% { background-color: #4a76c5; color: white; }
}

        .grafico-area { display: flex; align-items: center; gap: 10px; background: white; padding: 5px 10px; border-radius: 50px; border: 1px solid #ddd; }
        .donut-chart { width: 40px; height: 40px; border-radius: 50%; background: conic-gradient(#3d5a80 0% 0%, #e0e0e0 0% 100%); display: flex; align-items: center; justify-content: center; }
        .donut-hole { width: 28px; height: 28px; background: white; border-radius: 50%; }
        .porcentagem-texto { font-weight: bold; font-size: 0.8rem; color: #333; }

        /* BOT√ïES DE A√á√ÉO */
        .btn-acao { width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; transition: transform 0.2s; }
        .btn-acao:active { transform: scale(0.98); }
        .btn-estudar { background: #ff9800; }
        .btn-estudar.feito { background: #28a745; cursor: default; }
        
        /* NOVOS BOT√ïES DE PRESEN√áA */
        .status-box { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 10px; border: 1px solid transparent; }
        .status-box.verde { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-box.vermelho { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .btn-link { font-size: 0.7rem; text-decoration: underline; border: none; background: none; cursor: pointer; margin-left: 5px; }

        .status-presenca { width: 15px; height: 15px; border-radius: 50%; background: #ccc; border: 2px solid white; position: absolute; top: 15px; right: 15px; }
        .status-presenca.ok { background: #00b894; box-shadow: 0 0 5px #00b894; }
        .status-presenca.no { background: #d63031; box-shadow: 0 0 5px #d63031; }
        
        .section-label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 30px; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-top">
        <div>
            <h2 id="saudacao-titulo" class="saudacao-texto">A Paz de Deus!</h2>
            <div class="subtitulo-saudacao">Foque na sua parte.</div>
        </div>
        <div>
            <a href="perfil.html" style="margin-right:10px; text-decoration:none; color:#4a76c5; font-weight:bold;">üë§ Meu Perfil</a>
            <button onclick="sair()" class="btn-sair">Sair</button>
        </div>
    </div>

    <a href="status.html" class="btn-portal">üìä Ver Progresso da Obra (Todos os Grupos)</a>

    <div id="area-texto-biblico"></div>
    <div id="meu-painel"><p style="text-align:center">Carregando...</p></div>
    
    <div class="section-label">Irmandade Ativa</div>
    <div id="lista-outros"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yyktessyxnloyjwmydoj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3Rlc3N5eG5sb3lqd215ZG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQ1NzUsImV4cCI6MjA4NTkyMDU3NX0.bvktQ_DFH-CIszOlL0j1vrlIRM5sW3DIamjUy2fT__g';
        const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const meuId = localStorage.getItem('usuario_id');
        if (!meuId) window.location.href = 'index.html';

        function pegarDatasSemana() {
            const hoje = new Date();
            const diaSemana = hoje.getDay(); 
            const diff = hoje.getDate() - diaSemana + (diaSemana == 0 ? -6 : 1); 
            const datas = [];
            for (let i = 0; i < 6; i++) { 
                let d = new Date(hoje.setDate(diff + i));
                datas.push(d.toISOString().split('T')[0]);
            }
            return datas; 
        }

        async function carregarTudo() {
            try {
                const { data: perfis } = await clienteSupabase.from('profiles').select('*');
                const meuPerfil = perfis.find(p => p.id === meuId);
                if (meuPerfil) {
                    const nome = meuPerfil.nome_completo ? meuPerfil.nome_completo.split(' ')[0] : 'Irm√£o';
                    document.getElementById('saudacao-titulo').innerText = `A Paz de Deus, Irm√£o ${nome}!`;
                }

                const { data: recitativos } = await clienteSupabase.from('recitativos').select('*').eq('ativo', true).limit(1);
                if (!recitativos.length) { document.getElementById('meu-painel').innerHTML = 'Sem recitativo.'; return; }
                const recitativo = recitativos[0];

                document.getElementById('area-texto-biblico').innerHTML = `
                    <div class="recitativo-card">
                        <div class="recitativo-titulo">üìñ ${recitativo.tema}</div>
                        <div class="recitativo-texto">"${recitativo.conteudo_texto || '...'}"</div>
                    </div>`;

                const { data: atribuicoes } = await clienteSupabase.from('versoes_atribuidas').select('*').eq('recitativo_id', recitativo.id);
                
                const datasSemana = pegarDatasSemana();
                const hojeStr = new Date().toISOString().split('T')[0];
                
                const { data: estudos } = await clienteSupabase
                    .from('historico_estudos')
                    .select('data_estudo')
                    .eq('usuario_id', meuId)
                    .in('data_estudo', datasSemana);

                const diasEstudados = estudos.map(e => e.data_estudo);
                const estudeiHoje = diasEstudados.includes(hojeStr);

                let participantes = atribuicoes.map(atrib => {
                    const perfil = perfis.find(p => p.id === atrib.usuario_id) || {};
                    return { ...atrib, profiles: perfil };
                });
                participantes.sort((a, b) => (a.profiles.nome_completo || "").localeCompare(b.profiles.nome_completo || ""));

                const eu = participantes.find(p => p.usuario_id === meuId);
                const outros = participantes.filter(p => p.usuario_id !== meuId);

                if (eu) renderizarMeuCard(eu, diasEstudados, estudeiHoje, datasSemana);
                else document.getElementById('meu-painel').innerHTML = 'N√£o escalado.';
                
                document.getElementById('lista-outros').innerHTML = '';
                outros.forEach(p => renderizarOutroCard(p));

            } catch (e) { console.error(e); }
        }

       // --- NOVO ALGORITMO DE DISTRIBUI√á√ÉO ---
function calcularVersosDinamicos(eu, todosDoGrupo, faixaGeralStr) {
    // 1. Quem j√° confirmou?
    // Filtramos apenas quem est√° 'confirmado'
    const confirmados = todosDoGrupo.filter(p => p.status_presenca === 'confirmado');
    
    // Se ningu√©m confirmou ainda (nem eu), ou se eu n√£o confirmei:
    // A regra √©: mostra a faixa geral borrada.
    if (eu.status_presenca !== 'confirmado') {
        return { texto: faixaGeralStr, detalhe: "Confirme para revelar", classe: "misterio" };
    }

    // Se s√≥ eu confirmei ou se sou o √∫nico do grupo
    if (confirmados.length === 0) return { texto: faixaGeralStr, detalhe: "Voc√™ far√° tudo (por enquanto)", classe: "revelado" };

    // 2. Ordenar alfabeticamente (Regra do Jo√£o < Lucas)
    confirmados.sort((a, b) => {
        const nomeA = a.profiles.nome_completo || "";
        const nomeB = b.profiles.nome_completo || "";
        return nomeA.localeCompare(nomeB);
    });

    // 3. Entender os Versos (Ex: "1 ao 3")
    // Vamos tentar extrair os n√∫meros. Se n√£o conseguir, devolve o texto original.
    const numeros = faixaGeralStr.match(/\d+/g);
    if (!numeros || numeros.length < 2) {
        return { texto: faixaGeralStr, detalhe: "Verso Especial", classe: "revelado" };
    }

    const inicio = parseInt(numeros[0]);
    const fim = parseInt(numeros[1]);
    const totalVersos = fim - inicio + 1;
    const qtdPessoas = confirmados.length;

    // 4. A Matem√°tica da Divis√£o
    const versosPorPessoa = Math.floor(totalVersos / qtdPessoas);
    const sobra = totalVersos % qtdPessoas; // O resto da divis√£o vai para os primeiros da lista

    // Descobrir minha posi√ß√£o na fila
    const meuIndice = confirmados.findIndex(p => p.usuario_id === eu.usuario_id);
    
    // Se eu n√£o estiver na lista de confirmados (erro de seguran√ßa), retorna geral
    if (meuIndice === -1) return { texto: faixaGeralStr, detalhe: "Aguardando...", classe: "misterio" };

    // 5. Calcular meus versos espec√≠ficos
    // Logica: Quem tem indice menor que a sobra, ganha 1 a mais.
    let meuInicio = inicio;
    
    // Pula os versos dos irm√£os que v√™m antes de mim
    for (let i = 0; i < meuIndice; i++) {
        let qtdDesseIrmao = versosPorPessoa + (i < sobra ? 1 : 0);
        meuInicio += qtdDesseIrmao;
    }

    let minhaQtd = versosPorPessoa + (meuIndice < sobra ? 1 : 0);
    let meuFim = meuInicio + minhaQtd - 1;

    let textoFinal = "";
    if (minhaQtd === 1) textoFinal = `Verso ${meuInicio}`;
    else textoFinal = `Versos ${meuInicio} ao ${meuFim}`;

    return { texto: textoFinal, detalhe: "Sua parte espec√≠fica", classe: "revelado" };
}


// --- ATUALIZE ESTA FUN√á√ÉO EXISTENTE ---
function renderizarMeuCard(dados, diasEstudados, estudeiHoje, datasSemana, todosParticipantes) {
    const nome = dados.profiles.nome_completo || 'Eu';
    const inicial = nome.charAt(0).toUpperCase();
    
    // ... (Quadradinhos de dias continuam iguais) ...
    let htmlQuadradinhos = '';
    let qtdEstudos = 0;
    const hojeStr = new Date().toISOString().split('T')[0];
    const diaSemanaHoje = new Date().getDay(); // 0 = Domingo, 6 = Sabado

    datasSemana.forEach(data => {
        let classe = '';
        if (diasEstudados.includes(data)) { classe = 'verde'; qtdEstudos++; }
        else if (data === hojeStr) { classe = 'hoje-vazio'; }
        htmlQuadradinhos += `<div class="dia-quadrado ${classe}" title="${data}"></div>`;
    });
    const pctDedicao = Math.round((qtdEstudos / 6) * 100);
    
    let btnEstudo = estudeiHoje 
        ? `<button class="btn-acao btn-estudar feito">‚úÖ Estudo de Hoje Registrado!</button>`
        : `<button class="btn-acao btn-estudar" onclick="registrarEstudo()">üìñ Registrar Estudo de Hoje</button>`;

    // --- L√ìGICA DE PRESEN√áA ---
    let status = dados.status_presenca || 'pendente';
    let botoesPresenca = '';

    // Filtra apenas o meu grupo para o c√°lculo
    const meuGrupo = todosParticipantes.filter(p => p.grupo === dados.grupo);

    // CHAMA O MIST√âRIO!
    // Se for S√°bado (6) ou Domingo (0), revela tudo independente da confirma√ß√£o
    let versosCalculados;
    if (diaSemanaHoje === 6 || diaSemanaHoje === 0) {
        // Fim de semana: Mostra a divis√£o real baseada em quem confirmou
        versosCalculados = calcularVersosDinamicos({ ...dados, status_presenca: 'confirmado' }, meuGrupo, dados.faixa_versos);
        versosCalculados.classe = "revelado"; // For√ßa revelar
    } else {
        // Dia de semana: Segue a regra do "Confirma pra ver"
        versosCalculados = calcularVersosDinamicos(dados, meuGrupo, dados.faixa_versos);
    }


    if (status === 'confirmado') {
        botoesPresenca = `
            <div class="status-box verde">
                ‚úÖ Presen√ßa Confirmada!
                <button onclick="alterarStatus('${dados.id}', 'pendente')" class="btn-link" style="color:#155724">(Desfazer)</button>
            </div>`;
    } else if (status === 'nao_vou') {
        botoesPresenca = `
            <div class="status-box vermelho">
                ‚ùå Voc√™ informou que n√£o ir√°.
                <button onclick="alterarStatus('${dados.id}', 'pendente')" class="btn-link" style="color:#721c24">(Mudei de ideia)</button>
            </div>`;
    } else {
        botoesPresenca = `
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="alterarStatus('${dados.id}', 'confirmado')" class="btn-acao" style="background:#28a745; flex:1;">‚úÖ Confirmar</button>
                <button onclick="alterarStatus('${dados.id}', 'nao_vou')" class="btn-acao" style="background:#dc3545; flex:1;">‚ùå N√£o irei</button>
            </div>
            <p style="font-size:0.7rem; color:#666; text-align:center; margin-top:5px;">Confirme para ver seus versos exatos.</p>
        `;
    }

    let statusClass = '';
    if(status === 'confirmado') statusClass = 'ok';
    if(status === 'nao_vou') statusClass = 'no';

    const html = `
        <div class="dashboard-card" style="border: 2px solid #89b4fa;">
            <div class="status-presenca ${statusClass}"></div>
            <span class="grupo-badge">GRUPO ${dados.grupo}</span>
            <div class="card-content">
                <div class="perfil-area">
                    <div class="avatar">${inicial}</div>
                    <div class="info-nome"><div>${nome}</div>
                        <div class="dedicacao-area">${htmlQuadradinhos}</div>
                    </div>
                </div>
                
                <div class="verso-box ${versosCalculados.classe}">
                    <small>${versosCalculados.detalhe}</small>
                    <strong>${versosCalculados.texto}</strong>
                </div>

                <div class="grafico-area">
                    <div class="donut-chart" style="background: conic-gradient(#ff9800 0% ${pctDedicao}%, #e0e0e0 ${pctDedicao}%);">
                        <div class="donut-hole"></div>
                    </div>
                    <span class="porcentagem-texto">${pctDedicao}%</span>
                </div>
            </div>
            <div style="width:100%">
                ${btnEstudo}
                ${botoesPresenca}
            </div>
        </div>`;
    document.getElementById('meu-painel').innerHTML = html;
}
            // Define a bolinha de status no canto do card
            let statusClass = '';
            if(status === 'confirmado') statusClass = 'ok';
            if(status === 'nao_vou') statusClass = 'no';

            const html = `
                <div class="dashboard-card" style="border: 2px solid #89b4fa;">
                    <div class="status-presenca ${statusClass}"></div>
                    <span class="grupo-badge">GRUPO ${dados.grupo}</span>
                    <div class="card-content">
                        <div class="perfil-area">
                            <div class="avatar">${inicial}</div>
                            <div class="info-nome"><div>${nome}</div>
                                <div class="dedicacao-area">${htmlQuadradinhos}</div>
                            </div>
                        </div>
                        <div class="verso-box"><small>Versos</small><strong>${dados.faixa_versos}</strong></div>
                        <div class="grafico-area">
                            <div class="donut-chart" style="background: conic-gradient(#ff9800 0% ${pctDedicao}%, #e0e0e0 ${pctDedicao}%);">
                                <div class="donut-hole"></div>
                            </div>
                            <span class="porcentagem-texto">${pctDedicao}%</span>
                        </div>
                    </div>
                    <div style="width:100%">
                        ${btnEstudo}
                        ${botoesPresenca}
                    </div>
                </div>`;
            document.getElementById('meu-painel').innerHTML = html;
        }

        function renderizarOutroCard(dados) {
            let nome = dados.profiles.nome_completo || 'Irm√£o';
            let status = dados.status_presenca || 'pendente';
            let statusClass = '';
            if(status === 'confirmado') statusClass = 'ok';
            if(status === 'nao_vou') statusClass = 'no';

            const html = `
                <div class="dashboard-card">
                    <div class="status-presenca ${statusClass}"></div>
                    <span class="grupo-badge">GRUPO ${dados.grupo}</span>
                    <div class="card-content">
                        <div class="perfil-area">
                            <div class="avatar" style="background:#ccc; font-size:1rem;">${nome.charAt(0)}</div>
                            <div class="info-nome"><div>${nome}</div><span style="font-size:0.7rem">Versos ${dados.faixa_versos}</span></div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('lista-outros').innerHTML += html;
        }

        async function registrarEstudo() {
            const btn = document.querySelector('.btn-estudar');
            btn.innerText = "Registrando...";
            await clienteSupabase.from('historico_estudos').insert({ usuario_id: meuId });
            btn.innerText = "‚úÖ Estudo Registrado!";
            btn.classList.add('feito');
            setTimeout(carregarTudo, 1000); 
        }

        // NOVA FUN√á√ÉO PARA GERENCIAR OS 3 ESTADOS
        async function alterarStatus(id, novoStatus) {
            await clienteSupabase.from('versoes_atribuidas').update({ status_presenca: novoStatus }).eq('id', id);
            carregarTudo();
        }

        function sair() { localStorage.clear(); window.location.href = 'index.html'; }
        carregarTudo();
    </script>
</body>
</html>

